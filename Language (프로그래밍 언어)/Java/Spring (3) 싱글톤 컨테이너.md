# Spring - 싱글톤 컨테이너

---

### Spring에서 싱글톤을 사용하는 이유

> 애플리케이션 컨텍스트에 의해 등록된 빈은 기본적으로 싱글톤으로 관리된다. 즉, 스프링에 여러 번 빈을 요청하더라도 매번 동일한 객체를 돌려준다는 것이다. 애플리케이션 컨텍스트가 싱글톤으로 빈을 관리하는 이유는 대규모 트래픽을 처리할 수 있도록 하기 위함이다.
>
> 스프링은 최초에 설계될 때 부터 대규모의 엔터프라이즈 환경에서 요청을 처리할 수 있도록 고안되었다. 그리고 그에 따라 계층적으로 처리 구조(Controller, Service, Repository 등) 가 나뉘어지게 되었다.
>
> 그런데 매번 클라이언트에서 요청이 올 때마다 각 로직을 처리하는 빈을 새로 만들어서 사용한다고 생각해보자. 요청 1번에 5개의 객체가 만들어진다고 하고, 1초에 500번 요청이 온다고 하면 초당 2500개의 새로운 객체가 생성된다. 아무리 GC의 성능이 좋아졌다 하더라도 부하가 걸리면 감당이 힘들 것이다.
>
> 그래서 이러한 문제를 해결하고자 빈을 싱글톤 스코프로 관리하여 1개의 요청이 왔을 때 여러 쓰레드가 빈을 공유해 처리하도록 하였다.

### Spring에서 관리하는 싱글톤의 장점

- **단순 Java로 기본적인 싱글톤 패턴을 구현하고자 하면 다음과 같은 단점**들이 발생한다.
  - private 생성자를 갖고 있어 상속이 불가능하다.
  - 테스트하기 힘들다.
  - 서버 환경에서는 싱글톤이 1개만 생성됨을 보장하지 못한다.
  - 전역 상태를 만들 수 있기 때문에 바람직하지 못하다.
- 위와 같은 문제점이 있기 때문에 **스프링 자체에서 직접 싱글톤 형태의 오브젝트를 만들고 관리하는 기능을 제공**하는데, 그것이 바로 **싱글톤 레지스트리**(Singleton Registry) 이다. **스프링 컨테이너는 싱글톤을 생성하고, 관리하고 공급하는 컨테이너**이기도 하다. 싱글톤 레지스트리의 장점은 다음과 같다.
  - static 메소드나 private 생성자 등을 사용하지 않아 객체지향적 개발을 할 수 있다.
  - 테스트를 하기 편리하다.
- 기본적으로 싱글톤이 멀티쓰레드 환경에서 서비스 형태의 객체로 사용되기 위해서는 내부에 상태정보를 갖지 않는 무상태(Stateless) 방식으로 만들어져야 한다. 만약 여러 쓰레드들이 동시에 상태를 접근하여 수정한다면 상당히 위험하기 때문이다.
- 직접 싱글톤을 구현한다면 상당히 많은 단점들이 있겠지만, Spring 프레임워크에서 직접 싱글톤으로 객체를 관리해주므로, 우리는 더욱 객체지향적인 개발을 할 수 있게 된 것이다.

출처

- https://greatzzang21.tistory.com/38

---

### 스프링 도움없이 싱글톤 패턴 적용의 문제점

![image](https://user-images.githubusercontent.com/122634701/215333514-c8485a0f-6116-49d7-a4dc-556bf88e70a9.png)

- 싱글톤 패턴을 구현하는 코드 자체가 많이 들어간다.
- 의존 관계상 클라이언트가 구체 클래스에 의존한다. 👉 **DIP를 위반**한다.
- 클라이언트가 구체 클래스에 의존해서 **OCP 원칙을 위반**할 가능성이 높다.
- 테스트하기 어렵다.
- 내부 속성을 변경하거나 초기화 하기 어렵다.
- private 생성자로 자식 클래스를 만들기 어렵다.
- 결론적으로 유연성이 떨어진다.
- 안티패턴으로 불리기도 한다.

---

### 싱글톤 컨테이너 🔥🔥🔥

- 스프링 컨테이너는 싱글톤 패턴의 문제점을 해결하면서, 객체 인스턴스를 싱글톤(1개만 생성)으로 관리한다.
- 스프링 컨테이너는 싱글턴 패턴을 따로 적용해주지 않아도, 객체 인스턴스를 싱글톤으로 관리한다.
- 컨테이너는 **객체를 하나만 생성해서 관리**한다.
- 스프링 컨테이너는 싱글톤 컨테이너 역할을 한다. 이렇게 싱글톤 객체를 생성하고 관리하는 기능을 **싱글톤 레지스트리**라 한다.
- 싱글톤 패턴을 위한 지저분한 코드가 들어가지 않아도 된다.
- **DIP, OCP, 테스트, private 생성자로부터 자유롭게 싱글톤을 사용할 수 있다.**

---

### 싱글톤 방식의 주의점 🔥🔥🔥

- 이러한 싱글톤 방식으로 딱 하나 생성되어 관리되는 객체가 멀티스레드 환경에서 사용될 때 상태가 stateful하게 설계되어 있다면 큰 장애가 일어날 수 있다. 이런 경우 파악하기 힘들다.
- 무상태(stateless)로 설계되어야 한다.
  - 특정 클라이언트에 의존적인 필드가 있으면 안된다.
  - 특정 클라이언트가 값을 변경할 수 있는 필드가 있으면 안된다!
  - 가급적 읽기만 가능해야 한다.
  - 필드 대신에 자바에서 공유되지 않는, 지역변수, 파라미터, ThreadLocal 등을 사용해야 한다.

---

